# Review App Integration with Broadcast Generator - Update Summary

## Overview
Successfully updated the DJ Script Review web application to load and display scripts from broadcast JSON files generated by the broadcast engine. The review app can now display all broadcast segments for approval/rejection workflow.

## Key Changes

### 1. **Storage Module Enhancement** (`backend/storage.py`)
- Added `broadcast_path` configuration to locate broadcast output directory
- Implemented `_load_broadcast_scripts()` method to:
  - Parse broadcast JSON files from `c:\esp32-project\output\`
  - Extract individual segments as reviewable scripts
  - Filter out already-reviewed scripts (checked against metadata files)
  - Include validation scores and feedback from broadcast metadata
  - Handle corrupted/malformed JSON files gracefully

- Updated `approve_script()` and `reject_script()` to handle broadcast scripts:
  - For broadcast scripts: saves approval/rejection metadata to JSON files
  - For file-based scripts: uses original file movement workflow
  - Metadata stored in `output/scripts/metadata/` directory

- Modified `list_scripts_filtered()` to include broadcast scripts from JSON files alongside file-based scripts

### 2. **Data Model Enhancement** (`backend/models.py`)
Added optional fields to `Script` model for broadcast script metadata:
- `broadcast_id`: Source broadcast session ID
- `segment_index`: Position within broadcast (0-based)
- `validation_score`: LLM validation score (0.0-1.0)
- `validation_feedback`: LLM feedback text
- `weather_type`: Weather type for weather segments
- `source`: Indicates "broadcast" or "file" origin

### 3. **Directory Structure**
Broadcast scripts use this metadata storage structure:
```
output/scripts/metadata/
├── broadcast_[name]_seg[idx]_[type]_approval.json
├── broadcast_[name]_seg[idx]_[type]_rejection.json
├── approved.json (existing)
└── rejected.json (existing)
```

## Features

### Script Loading
- Automatically discovers and loads all `broadcast_*.json` files
- Extracts segments from broadcast metadata
- Displays segment type, DJ name, category, word count, timestamp
- Shows LLM validation score and feedback when available

### Review Workflow
- **Approve**: Records approval metadata, moves to next script
- **Reject**: Shows reason picker, saves rejection metadata with reason
- **Undo**: Reverses last action (removes metadata file)
- Keyboard support: Arrow keys for navigation (← Reject, → Approve)
- Swipe support: Left/right swipe on touch devices

### Filtering & Display
- Category filtering works with broadcast scripts (weather, gossip, music, general, news, story)
- DJ filter recognizes broadcast DJs (Mr. New Vegas, Julie, Three Dog, etc.)
- Weather type filtering for emergency alerts
- Date range filtering
- Pagination (20 scripts per page by default)

## Tested Scenarios

✅ **Approved** 3 broadcast scripts (music, gossip segments)
✅ **Rejected** 1 broadcast script with reason ("Too generic/boring")
✅ Metadata files created correctly in `output/scripts/metadata/`
✅ Already-reviewed scripts automatically excluded from pending list
✅ UI displays scripts with proper metadata (DJ, category, word count, timestamp)
✅ Validation feedback displayed when available
✅ Keyboard navigation (Arrow Left/Right) works correctly
✅ Server gracefully handles malformed JSON files

## Technical Details

### Broadcast JSON Format Expected
```json
{
  "metadata": {
    "dj": "DJ Name (location)",
    "generation_timestamp": "2026-01-19T22:28:58.685888"
  },
  "segments": [
    {
      "segment_type": "time_check|gossip|story|news|weather",
      "script": "Dialog text...",
      "weather_type": "dust_storm",
      "metadata": {
        "timestamp": "2026-01-19T22:28:58.685888",
        "validation": {
          "score": 0.95,
          "feedback": "Feedback text...",
          "issues": []
        }
      }
    }
  ]
}
```

### Metadata File Format
**Approval:**
```json
{
  "script_id": "broadcast_[name]_seg[idx]_[type]",
  "status": "approved",
  "timestamp": "2026-01-19T22:45:00.000000"
}
```

**Rejection:**
```json
{
  "script_id": "broadcast_[name]_seg[idx]_[type]",
  "status": "rejected",
  "reason_id": "too_generic",
  "custom_comment": null,
  "timestamp": "2026-01-19T22:45:55.000000"
}
```

## Integration Points

1. **Broadcast Generator** → generates `broadcast_*.json` files in `output/`
2. **Review App** → loads and displays scripts from these files
3. **Metadata Storage** → saves review decisions to `output/scripts/metadata/`
4. **Future Analytics** → can analyze metadata to improve generation quality

## Files Modified
- `backend/storage.py` - Broadcast script loading & review handling
- `backend/models.py` - Added broadcast metadata fields to Script model

## Testing Notes
- Server startup time slightly increased due to JSON file parsing (negligible)
- Corrupted JSON files are logged but don't break application
- Review UI is responsive and handles dynamic script loading
- Metadata directory auto-created on first review action

## Next Steps
1. Monitor metadata files for quality improvement feedback
2. Create analytics dashboard showing approval rates by DJ/category
3. Integrate rejection reasons back into broadcast generator for refinement
4. Add batch operations (approve all gossip, reject by category, etc.)

---
**Status**: ✅ Complete and tested
**Date**: 2026-01-19
**Tested by**: QA automation (Playwright)
